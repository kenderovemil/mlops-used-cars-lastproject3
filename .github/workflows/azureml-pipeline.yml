name: Run AzureML Pipeline

on:
  workflow_dispatch:
  push:
    paths:
      - mlops/azureml/train/newpipeline.yml
      - .github/workflows/azureml-pipeline.yml

env:
  RESOURCE_GROUP: streaming_autovehicle_pricing_MLOPS
  WORKSPACE_NAME: project_III_MLOPS

permissions:
  contents: read

jobs:
  submit-pipeline:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set RG and WS
        run: |
          echo "RESOURCE_GROUP=streaming_autovehicle_pricing_MLOPS" >> $GITHUB_ENV
          echo "WORKSPACE_NAME=project_III_MLOPS" >> $GITHUB_ENV

      - name: Update Azure CLI
        run: |
          sudo az upgrade --yes
          az --version

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Install Azure ML SDK
        run: pip install azure-ai-ml

      - name: Install Azure ML extension
        run: az extension add -n ml -y

      - name: Update Azure ML extension
        run: az extension update -n ml

      - name: Copy data file to mlops/azureml/train/data/
        run: |
          echo "üìÇ Copying data file to match path in pipeline YAML"
          mkdir -p mlops/azureml/train/data
          if [ -f "data/used_cars_raw.csv" ]; then
            cp data/used_cars_raw.csv mlops/azureml/train/data/used_cars_raw.csv
            echo "‚úÖ File copied successfully"
            ls -lh mlops/azureml/train/data/
          else
            echo "‚ö†Ô∏è  Source file not found: data/used_cars_raw.csv"
          fi

      - name: Validate resource group and workspace
        run: |
          echo "Using resource group: ${{ env.RESOURCE_GROUP }}"
          echo "Using workspace: ${{ env.WORKSPACE_NAME }}"
          az group show --name ${{ env.RESOURCE_GROUP }} || { echo "‚ùå Resource group not found"; exit 1; }
          az ml workspace show --name ${{ env.WORKSPACE_NAME }} --resource-group ${{ env.RESOURCE_GROUP }} || { echo "‚ùå Workspace not found"; exit 2; }

      - name: Submit pipeline job
        run: |
          echo "üîß Submitting pipeline from file: mlops/azureml/train/newpipeline.yml"
          run_id=$(az ml job create \
            --file ${{ github.workspace }}/mlops/azureml/train/newpipeline.yml \
            --resource-group ${{ env.RESOURCE_GROUP }} \
            --workspace-name ${{ env.WORKSPACE_NAME }} \
            --query name -o tsv)

          if [[ -z "$run_id" ]]; then
            echo "‚ùå Job creation failed"
            exit 3
          fi

          echo "üöÄ Job submitted: $run_id"
          az ml job show -n "$run_id" --resource-group ${{ env.RESOURCE_GROUP }} --workspace-name ${{ env.WORKSPACE_NAME }} --web

          status=$(az ml job show -n "$run_id" --resource-group ${{ env.RESOURCE_GROUP }} --workspace-name ${{ env.WORKSPACE_NAME }} --query status -o tsv)

          if [[ -z "$status" ]]; then
            echo "‚ùå Status query failed"
            exit 4
          fi

          running=("NotStarted" "Queued" "Starting" "Preparing" "Running" "Finalizing" "CancelRequested")
          while [[ ${running[*]} =~ $status ]]; do
            echo "‚è≥ Status: $status"
            sleep 15
            status=$(az ml job show -n "$run_id" --resource-group ${{ env.RESOURCE_GROUP }} --workspace-name ${{ env.WORKSPACE_NAME }} --query status -o tsv)
          done

          echo "‚úÖ Final status: $status"
          if [[ "$status" != "Completed" ]]; then
            echo "‚ùå Pipeline job failed or canceled"
            exit 5
          fi
