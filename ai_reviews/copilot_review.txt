GitHub Copilot Cross-Check â€“ Azure Login Diagnostics

Scope Review
- Inspected every workflow invoking `azure/login@v1`: `deploy-model-training-pipeline-classical.yml`, `custom-create-compute.yml`, `custom-register-dataset.yml`, `custom-register-environment.yml`, `custom-run-pipeline.yml`, and legacy `github_workflows/azureml-pipeline.yml`.
- Verified that each reusable workflow exposes an `auth-type` input and that the caller (`deploy-model-training-pipeline-classical.yml`) passes `IDENTITY`.

Configuration Matrix

| Workflow | Invocation | Auth Source | Permissions Present | Notes |
|----------|------------|-------------|---------------------|-------|
| deploy-model-training-pipeline-classical.yml | top-level | Literal `IDENTITY` | Global block (`id-token: write`) | Calls all reusable jobs |
| custom-create-compute.yml | reusable | `${{ inputs.auth-type }}` | Job-level `permissions` defined | Runs Python SDK path |
| custom-register-dataset.yml | reusable | `${{ inputs.auth-type }}` | Job-level `permissions` defined | Uses `az ml data` CLI |
| custom-register-environment.yml | reusable | `${{ inputs.auth-type }}` | Job-level `permissions` defined | Adds ML extension before az calls |
| custom-run-pipeline.yml | reusable | `${{ inputs.auth-type }}` | Job-level `permissions` defined | Submits Azure ML job |
| github_workflows/azureml-pipeline.yml | standalone | Literal `IDENTITY` | Workflow-level `permissions` block | Direct azure/ML-action usage |

Key Cross-Check Observations
1. `azure/login@v1` is pinned everywhere; new CLI releases now reject `--identity --username`, so upgrade to `azure/login@v2` is required repository-wide.

```41:46:.github/workflows/custom-run-pipeline.yml
        - name: Azure Login
          uses: azure/login@v1
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
```

2. Reusable inputs declare `auth-type` without defaults. Recommend enforcing `required: true` plus `default: SERVICE_PRINCIPAL` (after upgrading to v2) or removing the input entirely so callers cannot drift.

```18:30:.github/workflows/custom-create-compute.yml
      inputs:
        cluster_name:
          required: true
          type: string
// ... existing code ...
        auth-type:
          required: false
          type: string
```

3. Standalone workflow `github_workflows/azureml-pipeline.yml` hardcodes subscription/resource details inline; ensure the same Azure App Registration client ID powers its federated credential to avoid context mismatch.

```21:36:github_workflows/azureml-pipeline.yml
        - name: Azure Login
          uses: azure/login@v1
          with:
            client-id: ${{ secrets.AZURE_CLIENT_ID }}
            tenant-id: ${{ secrets.AZURE_TENANT_ID }}
            subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
            auth-type: IDENTITY
```

Federated Subject / Issuer Matrix (expected)
- issuer: `https://token.actions.githubusercontent.com`
- audience: `api://AzureADTokenExchange`
- subjects aligned with triggers:
  - `repo:kenderovemil/mlops-used-cars-lastproject3:ref:refs/heads/main` â€“ matches `push` to `main`
  - `repo:kenderovemil/mlops-used-cars-lastproject3:pull_request` â€“ covers PR workflows targeting `main`
  - `repo:kenderovemil/mlops-used-cars-lastproject3:ref:refs/pull/*` â€“ optional but recommended for future PR contexts
  - Add environment-specific subjects if GitHub environments are introduced (none currently referenced)

Proposed YAML Diff (minimal)
- Bump every `azure/login` invocation to `@v2`.
- Remove `auth-type` from the caller and reusable workflows; rely on the action's default OIDC detection.
- If keeping `auth-type` for clarity, rename to `oidc-auth-type`, set `default: SERVICE_PRINCIPAL`, and pass that value explicitly after the upgrade.

Proposed Python SDK Fallback
- The scripts under `mlops/scripts/` already ingest `AZURE_SUBSCRIPTION_ID`, `RESOURCE_GROUP`, and `WORKSPACE_NAME`; once login succeeds, they can fully replace CLI usage for compute/dataset/environment/pipeline operations, eliminating the `az extension` dependency.

Validation Checklist
1. After the YAML adjustments, run `gh workflow run deploy-model-training-pipeline-classical.yml --ref main` (or push a branch) and confirm the Azure Login step reports "Login using Workload Identity Federation" in the log.
2. Execute `az account show` in a follow-up step to verify the tenant/subscription match the expected values.
3. Re-run from a pull request branch to confirm federated subject coverage.
4. Archive the Azure Login log excerpt inside `ai_reviews/log_extracts/azure_login_debug.txt`.

GitHub Copilot Review: Azure Login Failure Analysis
Review Date: 2025-11-08
Repository: kenderovemil/mlops-used-cars-lastproject3
Issue: Persistent Azure Login Failures with auth-type: IDENTITY

1. AZURE LOGIN USAGE AUDIT - ALL WORKFLOWS

âœ… WORKFLOW: deploy-model-training-pipeline-classical.yml
   - Location: .github/workflows/deploy-model-training-pipeline-classical.yml
   - Trigger: push/pull_request on main branch
   - Permissions: âœ“ id-token: write, âœ“ contents: read (lines 11-13)
   - Uses sub-workflows: create-compute, register-dataset, register-environment, run-pipeline
   - Passes auth-type: IDENTITY to all sub-workflows
   - Secrets: âœ“ AZURE_CLIENT_ID, âœ“ AZURE_TENANT_ID, âœ“ AZURE_SUBSCRIPTION_ID

âœ… WORKFLOW: custom-create-compute.yml
   - Location: .github/workflows/custom-create-compute.yml
   - Type: workflow_call (reusable)
   - Azure Login: Line 48-54
     â€¢ client-id: ${{ secrets.AZURE_CLIENT_ID }}
     â€¢ tenant-id: ${{ secrets.AZURE_TENANT_ID }}
     â€¢ subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
     â€¢ auth-type: ${{ inputs.auth-type }}
   - Permissions: âœ“ id-token: write, âœ“ contents: read (lines 41-43)
   - Input Definition: auth-type (line 28-30) - required: false, type: string
   - Secrets: All three required secrets properly defined (lines 32-37)
   - Post-login: Uses Python SDK (create_compute.py) with DefaultAzureCredential

âœ… WORKFLOW: custom-register-dataset.yml
   - Location: .github/workflows/custom-register-dataset.yml
   - Type: workflow_call (reusable)
   - Azure Login: Line 43-49
     â€¢ client-id: ${{ secrets.AZURE_CLIENT_ID }}
     â€¢ tenant-id: ${{ secrets.AZURE_TENANT_ID }}
     â€¢ subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
     â€¢ auth-type: ${{ inputs.auth-type }}
   - Permissions: âœ“ id-token: write, âœ“ contents: read (lines 36-38)
   - Input Definition: auth-type (line 22-24) - required: false, type: string
   - Secrets: All three required secrets properly defined (lines 26-31)
   - Post-login: Uses Azure CLI commands (az ml data create)

âœ… WORKFLOW: custom-register-environment.yml
   - Location: .github/workflows/custom-register-environment.yml
   - Type: workflow_call (reusable)
   - Azure Login: Line 44-50
     â€¢ client-id: ${{ secrets.AZURE_CLIENT_ID }}
     â€¢ tenant-id: ${{ secrets.AZURE_TENANT_ID }}
     â€¢ subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
     â€¢ auth-type: ${{ inputs.auth-type }}
   - Permissions: âœ“ id-token: write, âœ“ contents: read (lines 37-39)
   - Input Definition: auth-type (line 24-26) - required: false, type: string
   - Secrets: All three required secrets properly defined (lines 28-33)
   - Post-login: Uses Azure CLI commands (az ml environment create)

âœ… WORKFLOW: custom-run-pipeline.yml
   - Location: .github/workflows/custom-run-pipeline.yml
   - Type: workflow_call (reusable)
   - Azure Login: Line 40-46
     â€¢ client-id: ${{ secrets.AZURE_CLIENT_ID }}
     â€¢ tenant-id: ${{ secrets.AZURE_TENANT_ID }}
     â€¢ subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
     â€¢ auth-type: ${{ inputs.auth-type }}
   - Permissions: âœ“ id-token: write, âœ“ contents: read (lines 32-34)
   - Input Definition: auth-type (line 18-20) - required: false, type: string
   - Secrets: All three required secrets properly defined (lines 22-27)
   - Post-login: Uses Azure CLI commands (az ml job create)

2. FEDERATED CREDENTIAL SUBJECT/ISSUER MATRIX

Required Federated Credentials for App Registration:

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Trigger Type  â”‚ Required Subject Pattern                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ push: main    â”‚ repo:kenderovemil/mlops-used-cars-lastproject3:           â”‚
â”‚               â”‚      ref:refs/heads/main                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ pull_request  â”‚ repo:kenderovemil/mlops-used-cars-lastproject3:           â”‚
â”‚               â”‚      pull_request                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ PR from fork  â”‚ repo:kenderovemil/mlops-used-cars-lastproject3:           â”‚
â”‚               â”‚      ref:refs/pull/*                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Common Issuer: https://token.actions.githubusercontent.com
Common Audience: api://AzureADTokenExchange

Workflow Triggers (deploy-model-training-pipeline-classical.yml):
- push: branches: [main]
- pull_request: branches: [main]

REQUIRED FEDERATED CREDENTIALS IN AZURE AD APP REGISTRATION:
1. Subject: repo:kenderovemil/mlops-used-cars-lastproject3:ref:refs/heads/main
   Issuer: https://token.actions.githubusercontent.com
   Audience: api://AzureADTokenExchange

2. Subject: repo:kenderovemil/mlops-used-cars-lastproject3:pull_request
   Issuer: https://token.actions.githubusercontent.com
   Audience: api://AzureADTokenExchange

3. CRITICAL FINDINGS

ğŸ”´ FINDING #1: No Manual az login Commands
   STATUS: âœ… PASSED
   - No workflows contain manual `az login` commands
   - All authentication goes through azure/login@v1 action

ğŸ”´ FINDING #2: Auth-Type Propagation
   STATUS: âš ï¸  ISSUE FOUND
   PROBLEM: auth-type input is defined as "required: false" in all workflows
   IMPACT: If auth-type is not provided or is empty, azure/login@v1 defaults
           to a different authentication mode, potentially triggering the
           "user-assigned managed identity" mode
   LOCATION:
   - custom-create-compute.yml: line 28-30
   - custom-register-dataset.yml: line 22-24
   - custom-register-environment.yml: line 24-26
   - custom-run-pipeline.yml: line 18-20
   
   CURRENT CODE:
      auth-type:
        required: false
        type: string
   
   RECOMMENDED FIX:
      auth-type:
        required: true
        type: string
        default: IDENTITY

ğŸ”´ FINDING #3: Permissions Declaration
   STATUS: âœ… PASSED
   - All workflows correctly declare id-token: write and contents: read
   - Permissions are at job level in all reusable workflows

ğŸ”´ FINDING #4: Secrets Configuration
   STATUS: âœ… PASSED
   - All three secrets (AZURE_CLIENT_ID, AZURE_TENANT_ID, AZURE_SUBSCRIPTION_ID)
     are properly declared and passed through workflow chain
   - No evidence of organization vs repository secret conflicts

ğŸ”´ FINDING #5: Azure Login Action Version
   STATUS: âœ… PASSED
   - All workflows use azure/login@v1 (consistent)
   - No version pinning issues

ğŸ”´ FINDING #6: Environment Flags
   STATUS: âœ… PASSED
   - No additional environment flags passed to azure/login@v1
   - No "enable-AzPSSession" or other flags that could trigger alternate modes

ğŸ”´ FINDING #7: Azure CLI Extension Management
   STATUS: âœ… PASSED
   - Workflows properly install and update Azure ML CLI extension
   - No conflicting Azure CLI configurations

4. ROOT CAUSE HYPOTHESIS

PRIMARY HYPOTHESIS: Default Auth-Type Fallback
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

When azure/login@v1 receives an empty or undefined auth-type parameter, it may:

1. Attempt to auto-detect the authentication method
2. Default to a legacy authentication mode
3. Interpret the presence of client-id as a managed identity configuration

The azure/login@v1 action logic likely:
- Checks if auth-type is explicitly set
- If not set or empty, defaults to a detection algorithm
- Sees client-id + subscription-id and assumes managed identity mode
- Attempts to use "user-assigned managed identity" with the client-id as the
  identity resource ID (not the App Registration client ID)
- Fails with "Passing the managed identity ID with --username is no longer 
  supported" because it's using deprecated az login syntax

SECONDARY HYPOTHESIS: Federated Credential Mismatch
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

If federated credentials in Azure AD don't exactly match the GitHub context:
- Workflow runs on "push to main" but federated credential has wrong subject
- Workflow triggered by pull_request but no PR federated credential exists
- Branch name or repository name mismatch in subject

This would cause OIDC token exchange to fail before reaching azure/login@v1.

TERTIARY HYPOTHESIS: azure/login@v1 Version Issue
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

The azure/login@v1 action may have a bug or undocumented behavior where:
- IDENTITY auth-type is interpreted as "OIDC" internally
- Error message incorrectly reports "Unsupported value 'OIDC'"
- Action conflates IDENTITY with managed identity instead of federated identity

5. PROPOSED YAML CHANGES

CHANGE #1: Make auth-type Required with Default
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

FILE: .github/workflows/custom-create-compute.yml
LINES: 28-30

BEFORE:
      auth-type:
        required: false
        type: string

AFTER:
      auth-type:
        required: true
        type: string
        default: IDENTITY

APPLY TO:
- custom-create-compute.yml (line 28-30)
- custom-register-dataset.yml (line 22-24)
- custom-register-environment.yml (line 24-26)
- custom-run-pipeline.yml (line 18-20)

RATIONALE:
- Ensures auth-type is always explicitly set
- Prevents azure/login@v1 from using auto-detection
- Makes IDENTITY the default for all workflows

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

CHANGE #2: Add Debug Context Step (Temporary)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

ADD TO ALL REUSABLE WORKFLOWS (after checkout, before Azure Login):

      - name: Debug GitHub Context
        run: |
          echo "=== GitHub Actions Context ==="
          echo "GITHUB_REF: ${{ github.ref }}"
          echo "GITHUB_EVENT_NAME: ${{ github.event_name }}"
          echo "GITHUB_REPOSITORY: ${{ github.repository }}"
          echo "GITHUB_SHA: ${{ github.sha }}"
          echo "GITHUB_ACTOR: ${{ github.actor }}"
          echo "=== Secrets Check (presence only) ==="
          echo "AZURE_CLIENT_ID present: ${{ secrets.AZURE_CLIENT_ID != '' }}"
          echo "AZURE_TENANT_ID present: ${{ secrets.AZURE_TENANT_ID != '' }}"
          echo "AZURE_SUBSCRIPTION_ID present: ${{ secrets.AZURE_SUBSCRIPTION_ID != '' }}"
          echo "=== Auth Type ==="
          echo "auth-type input: ${{ inputs.auth-type }}"
          echo "================================"

LOCATION TO ADD:
- custom-create-compute.yml: after line 46, before line 48
- custom-register-dataset.yml: after line 41, before line 43
- custom-register-environment.yml: after line 42, before line 44
- custom-run-pipeline.yml: after line 38, before line 40

RATIONALE:
- Captures exact context when Azure Login is attempted
- Verifies secrets are properly passed through workflow chain
- Confirms auth-type value at runtime
- Can be removed after issue is resolved

6. PYTHON SDK READINESS ASSESSMENT

âœ… Python Scripts Available for SDK Fallback:

1. mlops/scripts/create_compute.py
   - Uses: DefaultAzureCredential, MLClient, AmlCompute
   - Environment: AZURE_SUBSCRIPTION_ID, RESOURCE_GROUP, WORKSPACE_NAME
   - Status: READY âœ“
   - Currently used in custom-create-compute.yml workflow

2. mlops/scripts/register_dataset.py
   - Uses: DefaultAzureCredential, MLClient, load_data
   - Environment: AZURE_SUBSCRIPTION_ID, RESOURCE_GROUP, WORKSPACE_NAME,
                  DATASET_FILE, DATASET_NAME
   - Status: READY âœ“
   - Can replace CLI commands in custom-register-dataset.yml

3. mlops/scripts/register_environment.py
   - Uses: DefaultAzureCredential, MLClient, load_environment
   - Environment: AZURE_SUBSCRIPTION_ID, RESOURCE_GROUP, WORKSPACE_NAME, ENV_FILE
   - Status: READY âœ“
   - Can replace CLI commands in custom-register-environment.yml

4. mlops/scripts/run_pipeline.py
   - Uses: DefaultAzureCredential, MLClient, load_job
   - Environment: AZURE_SUBSCRIPTION_ID, RESOURCE_GROUP, WORKSPACE_NAME,
                  PIPELINE_FILE, JOB_NAME
   - Status: READY âœ“
   - Can replace CLI commands in custom-run-pipeline.yml

SDK FALLBACK STRATEGY:
If azure/login@v1 continues to fail, workflows can:
1. Remove azure/login@v1 step entirely
2. Install azure-ai-ml and azure-identity Python packages
3. Set required environment variables
4. Run Python SDK scripts directly
5. DefaultAzureCredential will use OIDC tokens from GitHub Actions environment

OIDC Token Availability:
- GitHub Actions automatically provides OIDC tokens when id-token: write is set
- DefaultAzureCredential automatically detects and uses these tokens
- No explicit azure/login@v1 step needed for Python SDK approach

7. CROSS-CHECK MATRIX: ALL AZURE/LOGIN@V1 USAGE

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Workflow File                                â”‚ Line  â”‚ Auth-Def â”‚ Perms   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ custom-create-compute.yml                    â”‚ 48-54 â”‚ 28-30    â”‚ 41-43 âœ“ â”‚
â”‚ custom-register-dataset.yml                  â”‚ 43-49 â”‚ 22-24    â”‚ 36-38 âœ“ â”‚
â”‚ custom-register-environment.yml              â”‚ 44-50 â”‚ 24-26    â”‚ 37-39 âœ“ â”‚
â”‚ custom-run-pipeline.yml                      â”‚ 40-46 â”‚ 18-20    â”‚ 32-34 âœ“ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

All workflows:
âœ“ Use azure/login@v1
âœ“ Pass client-id, tenant-id, subscription-id from secrets
âœ“ Pass auth-type from inputs
âœ— auth-type input is optional (required: false)
âœ“ Have id-token: write permissions
âœ“ Have contents: read permissions

8. EVIDENCE REQUIREMENTS

To complete diagnosis, the following evidence should be collected from actual
failed workflow runs:

1. Azure Login Step Logs:
   - Exact error message
   - Which authentication mode was detected/attempted
   - Any warnings about deprecated flags

2. GitHub Actions Environment:
   - Value of GITHUB_REF at runtime
   - Value of GITHUB_EVENT_NAME at runtime
   - Confirmation that AZURE_CLIENT_ID secret is non-empty

3. Azure AD App Registration:
   - List of all federated credentials (subject patterns)
   - Client ID of the App Registration
   - Confirmation that federated credentials match workflow triggers

4. Secret Origin:
   - Verify AZURE_CLIENT_ID is from correct App Registration
   - Confirm no conflicts between org and repo secrets

9. RECOMMENDATIONS SUMMARY

IMMEDIATE ACTION (Required):
1. Set auth-type as required with default value "IDENTITY" in all workflow inputs
2. Add temporary debug context step to capture runtime values
3. Verify federated credentials in Azure AD match GitHub triggers exactly

VALIDATION STEPS:
1. After changes, trigger workflow via push to main branch
2. Review debug context output
3. Confirm Azure Login step succeeds
4. Remove debug context step once stable

ALTERNATIVE PATH:
If azure/login@v1 continues to fail:
1. Remove azure/login@v1 from workflows that use Python SDK
2. Keep only Python SDK approach with DefaultAzureCredential
3. Keep azure/login@v1 only for workflows that require Azure CLI

END OF COPILOT REVIEW
